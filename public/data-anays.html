<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Face Show</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="echarts.min.js"></script>

<body>
 <div id="particles-js">
</div>
<div id="new-container">
       <div id="main-container" style="text-align: center;">
           <div id="new-title">颜值测试</div>
          <video id="video" autoplay width="350" height="300"></video>
           <div id="snap"><img src="src/take-photo.png"></div>
           <canvas id="canvas" width="640" height="480" style="display:none"></canvas>
       </div>
       <div id="cover" style="display:none">
        <img src="src/ball-triangle.svg" />
      </div>
      <div id="main" style="width: 360px;height:360px;"></div>
  

       <div id="footer">
           <span>
              
           </span>
       </div>
   </div>
<script src="particles.js"></script>
<script src="js/app.js"></script>

 <script type="text/javascript">
  $(function() {

  var videoProps = {
    video: {}
  };
  var p = navigator.mediaDevices.getUserMedia(videoProps);
  p.then(function(mediaStream) {
    var video = document.querySelector("video");
    console.log(mediaStream);
    video.srcObject=mediaStream;
  });
  p.catch(function(err) {
    console.log(err.name);
  });

  var canvas = document.querySelector("#canvas"),
    context = canvas.getContext("2d"),
    snap = document.querySelector("#snap"),
 /*   fenxi = document.querySelector("#fenxi"),
    beauty_button = document.querySelector("#beauty"),*/
    imgData = "";

  

    snap.addEventListener("click", function() {
    document.getElementById("cover").style.display = "flex";
    context.drawImage(video, 0, 0, 640, 480);
    // 获取情绪
    canvas.toBlob(function(blob) {
        console.log(blob);
        function blobToDataURL(blob, callback) {
        let a = new FileReader();
        a.onload = function (e) { callback(e.target.result); }
        a.readAsDataURL(blob);
    }
    blobToDataURL(blob, function (dataurl) {
    //console.log(dataurl);
    //return dataurl
        var str=dataurl.slice(22);
    
        console.log(str);
           var subscriptionKey ="24.bd656dfd4dd9d53fcbfbb030ab0309ad.2592000.1639486259.282335-25166469"
           ;
            var uriBase =
                "https://aip.baidubce.com/rest/2.0/face/v3/detect";
             var params = {
                "returnFaceId": "true",
                "returnFaceLandmarks": "false",
                "returnFaceAttributes":
                    "age,gender,headPose,smile,facialHair,glasses,emotion," +
                    "hair,makeup,occlusion,accessories,blur,exposure,noise"
            };
              $.ajax({
                url: uriBase + "?access_token=" + subscriptionKey,
                // Request headers.
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                type: "POST",
                 // Request body.
                data:{
                  image_type:"BASE64",
                  face_field:"emotion,age,beauty,gender,landmark,expression,quality,face_type,race,face_shape",
                  image: str,
                }
               
            })
            .done(function(data) {
              console.log(data.result);
              var d=JSON.stringify(data.result);
              console.log(d);
              
                if (data.result) {
                localStorage.setItem('returnData3', d);
       /*     document.getElementById("beauty").style.display = "flex";
              document.getElementById("fenxi").style.display = "flex";*/
               document.getElementById("cover").style.display = "none";
                option = {
                    tooltip : {
                        formatter: "{a} <br/>{b} : {c}%"
                    },
                    toolbox: {
                        feature: {
                            restore: {},
                            saveAsImage: {}
                        }
                    },
                    series: [
                        {
                            name: '颜值分数',
                            type: 'gauge',
                            detail: {formatter:'{value}分'},
                            data: [{value: data.result.face_list[0].beauty, name: ''}]
                        }
                    ]
                };
               myChart.setOption(option);
               
                
               
  
    
       

      
                


                  

        
               
              } else {
                alert("照片没有拍好，请重新拍!");
              }

              
               
         
          

          //情绪对应歌单
            

  //获取情绪歌单详情
             
    
            })
            .fail(function(err) {
              alert("Error: " + JSON.stringify(err));
            });
        });
    });
  });
})

        // 基于准备好的dom，初始化echarts实例
        console.log(1);
        var getLocalData= localStorage.getItem('returnData');
        console.log(getLocalData);
        var jsonObj = JSON.parse(getLocalData);
        //var jsonObj=JSON.parse(getLocalData);
        console.log(jsonObj.face_list[0].emotion);
        console.log(jsonObj);
        
        console.log(2);
        var getLocalData2= localStorage.getItem('returnData2');
        console.log(getLocalData2);
        var jsonObj = JSON.parse(getLocalData2);
        //var jsonObj=JSON.parse(getLocalData);
        console.log(jsonObj.face_list[0].emotion);
        console.log(jsonObj);

        console.log(2);
        var getLocalData2= localStorage.getItem('returnData3');
        console.log(getLocalData2);
        var jsonObj = JSON.parse(getLocalData2);
        //var jsonObj=JSON.parse(getLocalData);
        console.log(jsonObj.face_list[0].emotion);
        console.log(jsonObj);

        var myChart = echarts.init(document.getElementById('main'));

        // 指定图表的配置项和数据
		   

/*setInterval(function () {
    option.series[0].data[0].value = (Math.random() * 100).toFixed(2) - 0;
    myChart.setOption(option, true);
},2000);*/

        // 使用刚指定的配置项和数据显示图表。
        
    </script>


</body>
</html>